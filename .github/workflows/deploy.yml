name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 300s
          script: |
            set -e
            
            echo "╔════════════════════════════════════════╗"
            echo "║    BGalin Deployment Started           ║"
            echo "╚════════════════════════════════════════╝"
            
            # ============================================
            # 1. SETUP PREREQUISITES
            # ============================================
            echo ""
            echo "=== 1. Setup Prerequisites ==="
            
            # Create bgalin user if needed
            if ! id "bgalin" &>/dev/null; then
              echo "Creating bgalin user..."
              sudo useradd -m -s /bin/bash bgalin
            fi
            
            # Install Bun
            if ! [ -f "$HOME/.bun/bin/bun" ]; then
              echo "Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              sleep 2
            fi
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            echo "✓ Bun ready"
            
            # Install Node.js
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "✓ Node.js ready"
            
            # Install PM2
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2 --no-optional
              pm2 startup 2>/dev/null || true
              pm2 save 2>/dev/null || true
            fi
            echo "✓ PM2 ready"
            
            # Install Nginx
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            echo "✓ Nginx ready"
            
            # ============================================
            # 2. UPDATE REPOSITORY
            # ============================================
            echo ""
            echo "=== 2. Update Repository ==="
            cd /var/www/bgalin
            git fetch origin main
            git reset --hard origin/main
            echo "✓ Repository updated ($(git log -1 --oneline))"
            
            # ============================================
            # 3. CREATE .ENV FILE
            # ============================================
            echo ""
            echo "=== 3. Setup Configuration ==="
            if [ ! -f /var/www/bgalin/.env ]; then
              cat > /var/www/bgalin/.env << 'EOF'
            PORT=8000
            NODE_ENV=production
            EOF
              echo "✓ .env created"
            else
              echo "✓ .env exists"
            fi
            
            # ============================================
            # 4. BUILD BACKEND
            # ============================================
            echo ""
            echo "=== 4. Build Backend ==="
            export NODE_OPTIONS="--max-old-space-size=256"
            cd /var/www/bgalin/server
            bun install --prefer-offline 2>&1 | tail -5
            echo "✓ Backend ready"
            
            # ============================================
            # 5. BUILD FRONTEND
            # ============================================
            echo ""
            echo "=== 5. Build Frontend ==="
            cd /var/www/bgalin/frontend
            npm install --prefer-offline --no-audit 2>&1 | tail -3
            
            # Skip build if low memory (just use existing if available)
            if [ -d ".next" ]; then
              echo "✓ Frontend pre-built (using existing)"
            else
              echo "⚠ Frontend needs build, attempting..."
              npm run build 2>&1 | tail -5 || echo "⚠ Build skipped (low memory)"
            fi
            echo "✓ Frontend ready"
            
            # ============================================
            # 6. SETUP BACKEND SERVICE
            # ============================================
            echo ""
            echo "=== 6. Setup Backend Service ==="
            
            # Install Bun for bgalin user
            if [ ! -d /home/bgalin/.bun ]; then
              echo "Installing Bun for bgalin user..."
              sudo -u bgalin bash -c 'curl -fsSL https://bun.sh/install | bash' 2>&1 | tail -3
              sleep 2
            fi
            
            # Fix permissions
            sudo chown -R bgalin:bgalin /var/www/bgalin/server
            if [ -d /home/bgalin/.bun ]; then
              sudo chown -R bgalin:bgalin /home/bgalin/.bun
              sudo chmod +x /home/bgalin/.bun/bin/bun
              echo "✓ Bun permissions fixed"
            else
              echo "⚠ Bun directory issue"
            fi
            
            # Copy and enable service
            sudo cp /var/www/bgalin/bgalin-backend.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable bgalin-backend.service
            echo "✓ Backend service ready"
            
            # ============================================
            # 7. TRY DOCKER FOR N8N (OPTIONAL)
            # ============================================
            echo ""
            echo "=== 7. Optional: Docker Services ==="
            
            if command -v docker &> /dev/null && sudo systemctl is-active --quiet docker 2>/dev/null; then
              echo "Docker available, starting optional services..."
              if sudo docker-compose up -d 2>&1 | tail -3; then
                echo "✓ Docker services started"
                sleep 5
              fi
            else
              echo "⚠ Docker not available (optional)"
            fi
            
            # ============================================
            # 8. START MAIN SERVICES
            # ============================================
            echo ""
            echo "=== 8. Start Main Services ==="
            
            # Start backend
            sudo systemctl restart bgalin-backend.service
            sleep 3
            if sudo systemctl is-active --quiet bgalin-backend.service; then
              echo "✓ Backend running"
            else
              echo "⚠ Backend startup issue"
              sudo journalctl -u bgalin-backend.service -n 5 || true
            fi
            
            # Start frontend
            cd /var/www/bgalin
            pm2 delete bgalin-frontend 2>/dev/null || true
            sleep 1
            if pm2 start ecosystem.config.js; then
              pm2 save 2>/dev/null || true
              echo "✓ Frontend running on PM2"
            else
              echo "⚠ PM2 issue detected"
            fi
            
            sleep 3
            
            # ============================================
            # 9. SETUP NGINX
            # ============================================
            echo ""
            echo "=== 9. Setup Nginx ==="
            sudo cp /var/www/bgalin/nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            if sudo nginx -t 2>&1 | grep -q "successful"; then
              sudo systemctl restart nginx
              echo "✓ Nginx configured"
            else
              echo "⚠ Nginx config issue"
              sudo systemctl restart nginx || true
            fi
            
            # ============================================
            # 10. TEST ENDPOINTS
            # ============================================
            echo ""
            echo "=== 10. Test Endpoints ==="
            
            # Test backend
            BACKEND_OK=0
            for i in {1..10}; do
              if curl -s http://localhost:8000 2>&1 | grep -q "200\|html"; then
                echo "✓ Backend responding"
                BACKEND_OK=1
                break
              fi
              sleep 2
            done
            [ $BACKEND_OK -eq 0 ] && echo "⚠ Backend not responding yet"
            
            # Test frontend
            FRONTEND_OK=0
            for i in {1..10}; do
              if curl -s http://localhost:3000 2>&1 | grep -q "html\|doctype"; then
                echo "✓ Frontend responding"
                FRONTEND_OK=1
                break
              fi
              sleep 2
            done
            [ $FRONTEND_OK -eq 0 ] && echo "⚠ Frontend not responding yet"
            
            # ============================================
            # 10. SUMMARY
            # ============================================
            echo ""
            echo "╔════════════════════════════════════════╗"
            echo "║  ✅ Deployment Completed              ║"
            echo "╚════════════════════════════════════════╝"
            echo ""
            echo "Services:"
            echo "  • Frontend:  PM2 (port 3000)"
            echo "  • Backend:   systemd (port 8000)"
            echo "  • Proxy:     Nginx (80/443)"
            echo ""
            echo "Check status:"
            echo "  • pm2 status"
            echo "  • sudo systemctl status bgalin-backend"
            echo "  • sudo systemctl status nginx"
