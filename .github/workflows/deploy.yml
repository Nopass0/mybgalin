name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 300s
          script: |
            set -e
            
            echo "╔════════════════════════════════════════╗"
            echo "║    BGalin Deployment Started           ║"
            echo "║  Backend + Frontend + N8N              ║"
            echo "╚════════════════════════════════════════╝"
            
            # ============================================
            # 1. SETUP PREREQUISITES
            # ============================================
            echo ""
            echo "=== 1. Setup Prerequisites ==="
            
            # Install Bun
            if ! [ -f "$HOME/.bun/bin/bun" ]; then
              curl -fsSL https://bun.sh/install | bash
              sleep 2
            fi
            export PATH="$HOME/.bun/bin:$PATH"
            echo "✓ Bun ready"
            
            # Install Node.js
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "✓ Node.js ready"
            
            # Install PM2
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
              pm2 startup 2>/dev/null || true
            fi
            echo "✓ PM2 ready"
            
            # Install Docker
            if ! command -v docker &> /dev/null; then
              curl -fsSL https://get.docker.com | sh
            fi
            sudo systemctl start docker || sudo service docker start || true
            sudo systemctl enable docker 2>/dev/null || true
            
            # Wait for Docker daemon to be ready
            echo "Waiting for Docker daemon..."
            for i in {1..30}; do
              if sudo docker ps &>/dev/null; then
                echo "✓ Docker ready"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "⚠ Docker may not be ready, continuing anyway"
              fi
              sleep 1
            done
            
            # Install Nginx
            if ! command -v nginx &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            echo "✓ Nginx ready"
            
            # ============================================
            # 2. UPDATE REPOSITORY
            # ============================================
            echo ""
            echo "=== 2. Update Repository ==="
            
            # Ensure deployment directory exists
            DEPLOY_DIR="/var/www/bgalin"
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Creating deployment directory: $DEPLOY_DIR"
              sudo mkdir -p "$DEPLOY_DIR"
              sudo chown -R $(whoami):$(whoami) "$DEPLOY_DIR"
            fi
            
            cd "$DEPLOY_DIR"
            
            # Initialize git if not already a repo
            if [ ! -d .git ]; then
              git clone https://github.com/Nopass0/mybgalin.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi
            echo "✓ Repository updated"
            
            # ============================================
            # 3. START DOCKER SERVICES (N8N + PostgreSQL)
            # ============================================
            echo ""
            echo "=== 3. Start Docker Services (N8N + PostgreSQL) ==="
            
            # Create .env if missing
            if [ ! -f /var/www/bgalin/.env ]; then
              cat > /var/www/bgalin/.env << 'ENVEOF'
            POSTGRES_USER=admin
            POSTGRES_PASSWORD=admin
            POSTGRES_DB=bgalin
            N8N_HOST=bgalin.ru
            N8N_PORT=5678
            NODE_ENV=production
            ENVEOF
            fi
            
            # Retry docker-compose with exponential backoff
            cd /var/www/bgalin
            sudo docker-compose down 2>/dev/null || true
            sleep 2
            
            RETRY=0
            while [ $RETRY -lt 5 ]; do
              if sudo docker-compose up -d 2>&1; then
                sleep 10
                echo "Docker services:"
                sudo docker-compose ps
                echo "✓ Docker services running"
                break
              fi
              RETRY=$((RETRY + 1))
              echo "⚠ Docker-compose failed, retry $RETRY/5..."
              sleep $((RETRY * 2))
            done
            
            if [ $RETRY -eq 5 ]; then
              echo "⚠ Docker services failed to start, but continuing with PM2 deployment..."
            fi
            
            # ============================================
            # 4. BUILD FRONTEND
            # ============================================
            echo ""
            echo "=== 4. Build Frontend ==="
            cd /var/www/bgalin/frontend
            export NODE_OPTIONS="--max-old-space-size=512"
            npm install --prefer-offline 2>&1 | tail -3
            npm run build 2>&1 | tail -10 || echo "⚠ Build issues"
            echo "✓ Frontend built"
            
            # ============================================
            # 5. BUILD BACKEND
            # ============================================
            echo ""
            echo "=== 5. Build Backend ==="
            cd /var/www/bgalin/server
            bun install --prefer-offline 2>&1 | tail -3
            echo "✓ Backend built"
            
            # ============================================
            # 6. STOP OLD PM2 PROCESSES
            # ============================================
            echo ""
            echo "=== 6. Stop Old Processes ==="
            pm2 kill 2>/dev/null || true
            sleep 3
            echo "✓ Old processes stopped"
            
            # ============================================
            # 7. START BACKEND ON PM2
            # ============================================
            echo ""
            echo "=== 7. Start Backend ==="
            cd /var/www/bgalin/server
            pm2 start bun \
              --name backend \
              --args "run src/index.ts" \
              --max-memory-restart 400M \
              --restart-delay 5000 \
              --max-restarts 10 2>&1 | tail -5
            sleep 5
            echo "Backend:"
            pm2 status backend || echo "Starting..."
            
            # ============================================
            # 8. START FRONTEND ON PM2
            # ============================================
            echo ""
            echo "=== 8. Start Frontend ==="
            cd /var/www/bgalin/frontend
            pm2 start npm \
              --name frontend \
              --args "start" \
              --max-memory-restart 600M \
              --restart-delay 5000 \
              --max-restarts 10 2>&1 | tail -5
            sleep 5
            echo "Frontend:"
            pm2 status frontend || echo "Starting..."
            
            # ============================================
            # 9. SAVE PM2 STATE
            # ============================================
            echo ""
            echo "=== 9. Save PM2 State ==="
            pm2 save 2>/dev/null || true
            pm2 startup 2>/dev/null || true
            echo "✓ PM2 state saved"
            
            # ============================================
            # 10. SETUP NGINX
            # ============================================
            echo ""
            echo "=== 10. Setup Nginx ==="
            sudo cp /var/www/bgalin/nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            if sudo nginx -t 2>&1 | grep -q "successful"; then
              sudo systemctl restart nginx
              echo "✓ Nginx configured"
            else
              echo "⚠ Nginx issue"
              sudo systemctl restart nginx || true
            fi
            
            # ============================================
            # 11. FINAL STATUS
            # ============================================
            echo ""
            echo "╔════════════════════════════════════════╗"
            echo "║  ✅ Deployment Complete               ║"
            echo "╚════════════════════════════════════════╝"
            echo ""
            echo "PM2 Processes:"
            pm2 status || echo "⚠ PM2 status failed"
            echo ""
            echo "Docker Services:"
            sudo docker-compose ps 2>/dev/null || echo "⚠ Docker not available"
            echo ""
            echo "Access:"
            echo "  • Frontend:  https://bgalin.ru"
            echo "  • Backend:   https://bgalin.ru/api/health"
            echo "  • N8N:       https://bgalin.ru/n8n/"
            echo ""
            echo "Manage:"
            echo "  • pm2 status          - check processes"
            echo "  • pm2 logs backend    - backend logs"
            echo "  • pm2 logs frontend   - frontend logs"
            echo "  • docker-compose ps   - docker status"
