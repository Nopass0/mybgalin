name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 300s
          script: |
            set -e
            
            echo "╔════════════════════════════════════════╗"
            echo "║    BGalin Deployment Started           ║"
            echo "║  Backend + Frontend + N8N              ║"
            echo "╚════════════════════════════════════════╝"
            
            # ============================================
            # 1. SETUP PREREQUISITES
            # ============================================
            echo ""
            echo "=== 1. Setup Prerequisites ==="
            
            # Install Bun
            if ! [ -f "$HOME/.bun/bin/bun" ]; then
              curl -fsSL https://bun.sh/install | bash
              sleep 2
            fi
            export PATH="$HOME/.bun/bin:$PATH"
            echo "✓ Bun ready"
            
            # Install Node.js (for docker compose, not for running apps)
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "✓ Node.js ready"
            
            # Install Docker
            if ! command -v docker &> /dev/null; then
              curl -fsSL https://get.docker.com | sh
            fi
            sudo systemctl start docker || sudo service docker start || true
            sudo systemctl enable docker 2>/dev/null || true
            
            # Wait for Docker daemon to be ready
            echo "Waiting for Docker daemon..."
            for i in {1..30}; do
              if sudo docker ps &>/dev/null; then
                echo "✓ Docker ready"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "⚠ Docker may not be ready, continuing anyway"
              fi
              sleep 1
            done
            
            # Install Nginx
            if ! command -v nginx &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            echo "✓ Nginx ready"
            
            # ============================================
            # 2. UPDATE REPOSITORY
            # ============================================
            echo ""
            echo "=== 2. Update Repository ==="
            
            # Ensure deployment directory exists
            DEPLOY_DIR="/var/www/bgalin"
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Creating deployment directory: $DEPLOY_DIR"
              sudo mkdir -p "$DEPLOY_DIR"
              sudo chown -R $(whoami):$(whoami) "$DEPLOY_DIR"
            fi
            
            cd "$DEPLOY_DIR"
            
            # Initialize git if not already a repo
            if [ ! -d .git ]; then
              git clone https://github.com/Nopass0/mybgalin.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi
            echo "✓ Repository updated"
            
            # ============================================
            # 3. START DOCKER SERVICES (N8N + PostgreSQL)
            # ============================================
            echo ""
            echo "=== 3. Start Docker Services (N8N + PostgreSQL) ==="
            
            # Create .env if missing
            if [ ! -f /var/www/bgalin/.env ]; then
              cat > /var/www/bgalin/.env << 'ENVEOF'
            POSTGRES_USER=admin
            POSTGRES_PASSWORD=admin
            POSTGRES_DB=bgalin
            N8N_HOST=bgalin.ru
            N8N_PORT=5678
            NODE_ENV=production
            ENVEOF
            fi
            
            # Retry docker compose with exponential backoff and timeout
            cd /var/www/bgalin
            echo "Stopping existing containers..."
            timeout 10 sudo docker compose down 2>/dev/null || true
            sleep 2
            
            RETRY=0
            while [ $RETRY -lt 3 ]; do
              echo "Attempting to start Docker services (attempt $((RETRY + 1))/3)..."
              if timeout 30 sudo docker compose up -d 2>&1 | head -20; then
                echo "Waiting for containers to be ready..."
                sleep 5
                if timeout 10 sudo docker compose ps 2>&1 | head -20; then
                  echo "✓ Docker services running"
                  break
                fi
              fi
              RETRY=$((RETRY + 1))
              if [ $RETRY -lt 3 ]; then
                echo "⚠ Docker compose attempt failed, retrying in 5s..."
                sleep 5
              fi
            done
            
            if [ $RETRY -ge 3 ]; then
              echo "⚠ Docker services skipped, continuing with PM2 deployment only..."
            fi
            
            # ============================================
            # 4. REBUILD DOCKER IMAGES AND START ALL SERVICES
            # ============================================
            echo ""
            echo "=== 4. Rebuild and Start All Services ==="
            cd /var/www/bgalin
            
            # Rebuild images with backend and frontend
            echo "Building Docker images..."
            timeout 120 sudo docker compose build --no-cache 2>&1 | tail -20 || echo "⚠ Build completed with warnings"
            
            # Stop and recreate all containers
            echo "Stopping existing containers..."
            timeout 10 sudo docker compose down 2>/dev/null || true
            sleep 2
            
            # Start all services
            echo "Starting all services..."
            timeout 60 sudo docker compose up -d 2>&1 | tail -10
            sleep 10
            
            echo "Verifying services..."
            timeout 10 sudo docker compose ps 2>&1
            echo "✓ All services started"
            
            # ============================================
            # 5. SETUP NGINX
            # ============================================
            echo ""
            echo "=== 5. Setup Nginx ==="
            sudo cp /var/www/bgalin/nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            if sudo nginx -t 2>&1 | grep -q "successful"; then
              sudo systemctl restart nginx
              echo "✓ Nginx configured"
            else
              echo "⚠ Nginx issue"
              sudo systemctl restart nginx || true
            fi
            
            # ============================================
            # 6. FINAL STATUS
            # ============================================
            echo ""
            echo "╔════════════════════════════════════════╗"
            echo "║  ✅ Deployment Complete               ║"
            echo "╚════════════════════════════════════════╝"
            echo ""
            echo "Docker Services:"
            timeout 10 sudo docker compose ps 2>/dev/null || echo "⚠ Docker services status unavailable"
            echo ""
            echo "Service Logs:"
            echo "  • docker compose logs backend    - backend logs"
            echo "  • docker compose logs frontend   - frontend logs"
            echo "  • docker compose logs n8n        - N8N logs"
            echo "  • docker compose logs postgres   - PostgreSQL logs"
            echo ""
            echo "Access:"
            echo "  • Frontend:  https://bgalin.ru"
            echo "  • Backend:   https://bgalin.ru/api/health"
            echo "  • N8N:       https://bgalin.ru/n8n/"
            echo ""
            echo "Management:"
            echo "  • docker compose ps              - view all services"
            echo "  • docker compose restart         - restart services"
            echo "  • docker compose down            - stop all services"
            echo "  • docker compose up -d           - start all services"
