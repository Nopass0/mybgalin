name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 300s
          script: |
            set -e
            
            echo "╔════════════════════════════════════════╗"
            echo "║    BGalin Deployment Started           ║"
            echo "╚════════════════════════════════════════╝"
            
            # ============================================
            # 1. SETUP PREREQUISITES
            # ============================================
            echo ""
            echo "=== 1. Setting Up Prerequisites ==="
            
            # Ensure bgalin user exists
            if ! id "bgalin" &>/dev/null; then
              echo "Creating bgalin user..."
              sudo useradd -m -s /bin/bash bgalin
              echo "bgalin user created"
            fi
            
            # Docker is OPTIONAL - not required
            echo "Docker will be skipped (using PM2/systemd only)"
            
            # Install Bun if needed
            if ! [ -f "$HOME/.bun/bin/bun" ]; then
              echo "Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              sleep 2
            fi
            
            # Set Bun path explicitly
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            
            # Verify Bun binary exists (don't run it due to memory constraints)
            if [ -f "$BUN_INSTALL/bin/bun" ]; then
              echo "✓ Bun installed"
            else
              echo "❌ Bun installation failed"
              exit 1
            fi
            
            # Install/Update Node.js if needed
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "✓ Node.js ready"
            
            # Install PM2 globally only if needed
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2 --no-optional --prefer-offline
              pm2 startup -u $USER --hp /home/$USER 2>/dev/null || true
              pm2 save 2>/dev/null || true
            fi
            echo "✓ PM2 ready"
            
            # ============================================
            # 2. UPDATE REPOSITORY
            # ============================================
            echo ""
            echo "=== 2. Updating Repository ==="
            cd /var/www/bgalin
            git fetch origin main || { echo "❌ Git fetch failed"; exit 1; }
            git reset --hard origin/main || { echo "❌ Git reset failed"; exit 1; }
            COMMIT=$(git log --oneline -1)
            echo "Current commit: $COMMIT"
            echo "✓ Repository updated"
            
            # ============================================
            # 3. CREATE CONFIGURATION
            # ============================================
            echo ""
            echo "=== 3. Creating Configuration ==="
            
            # Create .env if it doesn't exist
            if [ ! -f /var/www/bgalin/.env ]; then
              echo "Creating .env file..."
              cat > /var/www/bgalin/.env << 'ENVEOF'
            # Backend
            PORT=8000
            NODE_ENV=production
            
            # Optional: Database settings (if using external DB)
            # DATABASE_URL="postgresql://user:pass@host:5432/bgalin"
            ENVEOF
              echo "✓ .env created"
            else
              echo "✓ .env already exists"
            fi
            
            # Check if services started
            sudo docker-compose ps
            if ! sudo docker ps | grep -q bgalin_postgres_1; then
              echo "⚠ PostgreSQL container might not be fully ready, waiting..."
              sleep 10
            fi
            echo "✓ Docker services started"
            
            # ============================================
            # 4. SETUP & BUILD BACKEND
            # ============================================
            echo ""
            echo "=== 4. Building Backend (Bun) ==="
            
            # Ensure PATH includes Bun
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            
            # Reduce memory usage
            export NODE_OPTIONS="--max-old-space-size=256"
            
            cd /var/www/bgalin/server
            
            # Install dependencies
            if bun install --prefer-offline 2>&1 | tail -10; then
              echo "✓ Backend dependencies installed"
            else
              echo "⚠ Backend install had issues, continuing..."
            fi
            
            echo "✓ Backend ready"
            
            # ============================================
            # 5. SETUP & BUILD FRONTEND
            # ============================================
            echo ""
            echo "=== 5. Building Frontend (Next.js) ==="
            
            # Reduce memory for Next.js build
            export NODE_OPTIONS="--max-old-space-size=256"
            
            cd /var/www/bgalin/frontend
            
            # Install with optimizations for low-memory
            npm install --prefer-offline --no-audit 2>&1 | tail -20
            echo "✓ Dependencies installed"
            
            # Build frontend (may be skipped if OOM)
            if npm run build 2>&1 | tail -20; then
              echo "✓ Frontend built successfully"
            else
              echo "⚠ Frontend build incomplete, continuing with deployment"
            fi
            
            # ============================================
            # 6. INSTALL SYSTEMD SERVICE FOR BACKEND
            # ============================================
            echo ""
            echo "=== 6. Installing Backend Service ==="
            
            # Copy systemd service file
            sudo cp /var/www/bgalin/bgalin-backend.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable bgalin-backend.service
            
            # Set ownership
            sudo chown bgalin:bgalin /var/www/bgalin/server -R
            
            # Install Bun for bgalin user if needed
            if [ ! -d /home/bgalin/.bun ]; then
              echo "Installing Bun for bgalin user..."
              sudo -u bgalin bash -c 'curl -fsSL https://bun.sh/install | bash'
            fi
            
            echo "✓ Systemd service installed"
            
            # ============================================
            # 7. START SERVICES
            # ============================================
            echo ""
            echo "=== 7. Starting Services ==="
            
            # Start backend with systemd
            echo "Starting backend..."
            sudo systemctl daemon-reload
            sudo systemctl enable bgalin-backend.service
            sudo systemctl restart bgalin-backend.service
            sleep 3
            
            if sudo systemctl is-active --quiet bgalin-backend.service; then
              echo "✓ Backend running on systemd"
            else
              echo "⚠ Backend startup issue, attempting restart..."
              sudo systemctl restart bgalin-backend.service
              sleep 3
            fi
            
            # Start frontend with PM2
            echo "Starting frontend..."
            cd /var/www/bgalin
            pm2 delete bgalin-frontend 2>/dev/null || true
            sleep 1
            
            if pm2 start ecosystem.config.js; then
              pm2 save 2>/dev/null || true
              echo "✓ Frontend running on PM2"
            else
              echo "⚠ PM2 start had issues, attempting manual start..."
              pm2 resurrect 2>/dev/null || echo "Could not resurrect PM2"
            fi
            
            sleep 3
            
            # ============================================
            # 8. VERIFY ALL SERVICES
            # ============================================
            echo ""
            echo "=== 8. Verifying Services ==="
            
            echo "Docker containers:"
            sudo docker ps --format "table {{.Names}}\t{{.Status}}"
            
            echo ""
            echo "PM2 processes:"
            pm2 status 2>/dev/null || echo "PM2 status unavailable"
            
            echo ""
            echo "Backend service:"
            sudo systemctl status bgalin-backend.service --no-pager | head -10 || true
            
            # ============================================
            # 8. SETUP NGINX REVERSE PROXY
            # ============================================
            echo ""
            echo "=== 8. Setting Up Nginx Reverse Proxy ==="
            
            # Install Nginx if needed
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # Copy Nginx config
            sudo cp /var/www/bgalin/nginx-bgalin.conf /etc/nginx/sites-available/bgalin 2>/dev/null || true
            
            # Enable site
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            # Test and restart Nginx
            if sudo nginx -t 2>&1 | grep -q "successful"; then
              echo "✓ Nginx config valid"
              sudo systemctl restart nginx
              echo "✓ Nginx restarted"
            else
              echo "⚠ Nginx config issue, but continuing..."
              sudo systemctl restart nginx || true
            fi
            
            # Copy Nginx config
            sudo cp /var/www/bgalin/nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            
            # Enable site if not already enabled
            if [ ! -L /etc/nginx/sites-enabled/bgalin ]; then
              echo "Enabling Nginx site..."
              sudo ln -s /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            fi
            
            # Disable default site if enabled
            sudo rm -f /etc/nginx/sites-enabled/default || true
            
            # Test Nginx configuration
            if sudo nginx -t > /dev/null 2>&1; then
              echo "✓ Nginx configuration is valid"
              sudo systemctl restart nginx
              echo "✓ Nginx restarted"
            else
              echo "⚠ Nginx configuration has errors, but continuing..."
              sudo systemctl restart nginx || true
            fi
            
            # ============================================
            # 9. TEST ENDPOINTS
            # ============================================
            echo ""
            echo "=== 9. Testing Endpoints ==="
            
            # Test Backend
            echo "Testing Backend API..."
            BACKEND_OK=0
            for i in {1..15}; do
              if curl -s http://localhost:8000/api/health 2>&1 | grep -q "200\|ok\|status"; then
                echo "✓ Backend responding"
                BACKEND_OK=1
                break
              fi
              echo "  Attempt $i/15..."
              sleep 2
            done
            
            if [ $BACKEND_OK -eq 0 ]; then
              echo "⚠ Backend not responding yet, but deployment continues"
              echo "  Check with: curl http://localhost:8000/api/health"
            fi
            
            # Test Frontend
            echo "Testing Frontend..."
            FRONTEND_OK=0
            for i in {1..15}; do
              if curl -s http://localhost:3000 2>&1 | grep -q "html\|doctype\|200"; then
                echo "✓ Frontend responding"
                FRONTEND_OK=1
                break
              fi
              echo "  Attempt $i/15..."
              sleep 2
            done
            
            if [ $FRONTEND_OK -eq 0 ]; then
              echo "⚠ Frontend not responding yet, but deployment continues"
              echo "  Check with: curl http://localhost:3000"
            fi
            
            # ============================================
            # 10. FINAL STATUS
            # ============================================
            echo ""
            echo "╔════════════════════════════════════════╗"
            echo "║  ✅ Deployment Completed Successfully  ║"
            echo "╚════════════════════════════════════════╝"
            echo ""
            echo "Services deployed:"
            echo "  • Frontend:   localhost:3000 (PM2)"
            echo "  • Backend:    localhost:8000 (systemd)"
            echo "  • Nginx:      Port 80/443 (reverse proxy)"
            echo ""
            echo "Access via Nginx:"
            echo "  • https://bgalin.ru           (Frontend)"
            echo "  • https://bgalin.ru/api/health (Backend health)"
            echo ""
            echo "Check status:"
            echo "  • pm2 status                    (Frontend)"
            echo "  • sudo systemctl status bgalin-backend.service (Backend)"
            echo "  • sudo systemctl status nginx   (Reverse proxy)"
            echo ""
            echo "View logs:"
            echo "  • pm2 logs bgalin-frontend"
            echo "  • sudo journalctl -u bgalin-backend.service -f"
            echo ""
