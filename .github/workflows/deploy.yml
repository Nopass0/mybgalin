name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 300s
          command_timeout: 120s
          script: |
            set -e
            
            echo "=== Deployment Started ==="
            
            # Ensure Docker is running
            echo "=== Checking Docker ==="
            sudo systemctl start docker 2>/dev/null || true
            sudo systemctl enable docker 2>/dev/null || true
            docker --version || echo "Docker not found"
            
            # Install docker-compose if needed
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing docker-compose..."
              sudo apt-get update
              sudo apt-get install -y docker-compose
            fi
            docker-compose --version
            
            # Update repository
            echo "=== Updating Repository ==="
            cd /var/www/bgalin
            git fetch origin main || true
            git reset --hard origin/main || true
            git log --oneline -1
            
            # Start services
            echo "=== Starting Services ==="
            docker-compose up -d || echo "Docker compose up failed, continuing..."
            sleep 15
            
            # Show status
            echo "=== Service Status ==="
            docker-compose ps 2>&1 || true
            docker ps -a 2>&1 || true
            
            # Test endpoints
            echo "=== Testing Endpoints ==="
            for i in {1..5}; do
              echo "Attempt $i..."
              curl -s http://localhost:5678 > /dev/null && echo "✅ N8N responding" && break
              sleep 5
            done
            
            curl -s http://localhost:5678 | head -c 50 || echo "N8N not responding yet"
            
            echo "✅ Deployment completed"
