name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build Rust backend for ARM64
        working-directory: ./server
        run: |
          cross build --release --target aarch64-unknown-linux-gnu

      - name: Upload backend binary
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: server/target/aarch64-unknown-linux-gnu/release/server
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download backend binary
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: ./backend-binary

      - name: Compress binary with maximum compression
        run: |
          gzip -9 ./backend-binary/server
          ls -la ./backend-binary/

      - name: Upload binary to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-build
          files: ./backend-binary/server.gz
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GTHUB_TOKEN }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          command_timeout: 60m
          script: |
            set -e

            echo "üöÄ Starting deployment..."

            # Stop services
            sudo systemctl stop bgalin-backend.service || true
            pm2 stop all || true

            # Setup project directory
            echo "üìÅ Setting up project directory..."
            sudo mkdir -p /var/www/bgalin
            sudo chown -R $USER:$USER /var/www/bgalin
            cd /var/www/bgalin

            # Setup SSH key for GitHub
            echo "üîë Setting up SSH authentication..."
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            
            # Clone or update repository using SSH
            echo "üì• Fetching latest code..."
            REPO_URL="git@github.com:Nopass0/mybgalin.git"
            
            if [ -d ".git" ]; then
              git remote set-url origin "$REPO_URL"
              git fetch origin main --depth=1
              git reset --hard origin/main
              git clean -fd
            else
              git clone --depth=1 "$REPO_URL" .
            fi

            # Install system dependencies if needed
            echo "üì¶ Checking system dependencies..."
            
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi

            if ! command -v nginx &> /dev/null; then
              echo "Installing nginx..."
              sudo apt-get install -y nginx
            fi

            # Download pre-built backend binary from GitHub Release
            echo "üì¶ Downloading backend binary..."
            mkdir -p /var/www/bgalin/server/target/release
            cd /var/www/bgalin/server/target/release
            
            # Download compressed binary from GitHub Release
            wget -q -O server.gz "https://github.com/Nopass0/mybgalin/releases/download/latest-build/server.gz" || {
              echo "Failed to download binary, trying alternative..."
              curl -sL -o server.gz "https://github.com/Nopass0/mybgalin/releases/download/latest-build/server.gz"
            }
            
            # Decompress
            gunzip -f server.gz
            chmod +x server
            cd /var/www/bgalin

            # Start n8n via Docker Compose
            echo "üê≥ Starting n8n..."
            if command -v docker >/dev/null && docker info >/dev/null; then
              if [ -f "docker-compose.yml" ]; then
                echo "Found docker-compose.yml, starting n8n..."
                sudo docker compose up -d n8n
              else
                echo "‚ö†Ô∏è docker-compose.yml not found"
              fi
            else
              echo "‚ö†Ô∏è Docker not available, skipping n8n"
            fi

            # Create/update .env file

            echo "üîê Updating environment variables..."
            cd server
            # Create/update .env file (using printf to avoid heredoc issues)
            printf "DATABASE_URL=${{ secrets.DATABASE_URL }}\n" > .env
            printf "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}\n" >> .env
            printf "ADMIN_TELEGRAM_ID=${{ secrets.ADMIN_TELEGRAM_ID }}\n" >> .env
            printf "STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}\n" >> .env
            printf "STEAM_ID=${{ secrets.STEAM_ID }}\n" >> .env
            printf "FACEIT_API_KEY=${{ secrets.FACEIT_API_KEY }}\n" >> .env
            printf "GSI_AUTH_TOKEN=${{ secrets.GSI_AUTH_TOKEN }}\n" >> .env
            printf "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}\n" >> .env
            printf "AI_MODEL=${{ secrets.AI_MODEL }}\n" >> .env
            printf "HH_CLIENT_ID=${{ secrets.HH_CLIENT_ID }}\n" >> .env
            printf "HH_CLIENT_SECRET=${{ secrets.HH_CLIENT_SECRET }}\n" >> .env
            printf "HH_REDIRECT_URI=https://bgalin.ru/auth/hh/callback\n" >> .env
            printf "JOB_SEARCH_INTERVAL_HOURS=${{ secrets.JOB_SEARCH_INTERVAL_HOURS }}\n" >> .env
            printf "ROCKET_ADDRESS=0.0.0.0\n" >> .env
            printf "ROCKET_PORT=3001\n" >> .env
            printf "ROCKET_ENV=production\n" >> .env
            printf "ALICE_CLIENT_ID=${{ secrets.ALICE_CLIENT_ID }}\n" >> .env
            printf "ALICE_CLIENT_SECRET=${{ secrets.ALICE_CLIENT_SECRET }}\n" >> .env
            printf "N8N_API_URL=http://localhost:5678\n" >> .env
            printf "N8N_API_KEY=${{ secrets.N8N_API_KEY }}\n" >> .env

            # Create data directory
            echo "üìÅ Creating data directory..."
            mkdir -p /var/www/bgalin/server/data
            chmod 755 /var/www/bgalin/server/data

            # Build frontend
            echo "üé® Building frontend..."
            cd ../frontend
            rm -rf node_modules package-lock.json
            npm install --build-from-source
            NODE_ENV=production npm run build

            # Setup systemd service
            echo "‚öôÔ∏è Configuring systemd service..."
            sudo printf "[Unit]\nDescription=BGalin Backend Service\nAfter=network.target\n\n[Service]\nType=simple\nUser=$USER\nWorkingDirectory=/var/www/bgalin/server\nEnvironmentFile=/var/www/bgalin/server/.env\nExecStart=/var/www/bgalin/server/target/release/server\nRestart=always\nRestartSec=10\nEnvironment=\"RUST_LOG=info\"\n\n[Install]\nWantedBy=multi-user.target\n" | sudo tee /etc/systemd/system/bgalin-backend.service > /dev/null
            sudo systemctl daemon-reload
            sudo systemctl enable bgalin-backend.service

            # Setup nginx
            echo "üåê Configuring nginx..."
            sudo printf "server {\n    listen 80;\n    server_name bgalin.ru www.bgalin.ru;\n    return 301 https://\$server_name\$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name bgalin.ru www.bgalin.ru;\n\n    ssl_certificate /var/www/bgalin/bgalin_ru.crt;\n    ssl_certificate_key /var/www/bgalin/private.key;\n\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers HIGH:!aNULL:!MD5;\n    ssl_prefer_server_ciphers on;\n\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \$http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host \$host;\n        proxy_cache_bypass \$http_upgrade;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n    }\n\n    location /api/ {\n        proxy_pass http://localhost:3001/api/;\n        proxy_http_version 1.1;\n        proxy_set_header Host \$host;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n    }\n\n    location /alice/ {\n        proxy_pass http://localhost:3001/alice/;\n        proxy_http_version 1.1;\n        proxy_set_header Host \$host;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n    }\n\n    location /n8n/ {\n        proxy_pass http://localhost:5678/;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \$http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host \$host;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n        proxy_buffering off;\n        chunked_transfer_encoding off;\n        proxy_cache off;\n    }\n\n    location /webhook/ {\n        proxy_pass http://localhost:5678/webhook/;\n        proxy_set_header Host \$host;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n        proxy_buffering off;\n        chunked_transfer_encoding off;\n        proxy_cache off;\n    }\n\n    add_header X-Frame-Options \"SAMEORIGIN\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header Referrer-Policy \"no-referrer-when-downgrade\" always;\n\n    access_log /var/log/nginx/bgalin_access.log;\n    error_log /var/log/nginx/bgalin_error.log;\n}\n" | sudo tee /etc/nginx/sites-available/bgalin > /dev/null
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default

            # Setup PM2 config
            if [ ! -f "/var/www/bgalin/frontend/ecosystem.config.js" ]; then
              echo "üì¶ Creating PM2 config..."
              printf "module.exports = {\n  apps: [{\n    name: 'bgalin-frontend',\n    script: 'node_modules/next/dist/bin/next',\n    args: 'start',\n    cwd: '/var/www/bgalin/frontend',\n    instances: 1,\n    autorestart: true,\n    watch: false,\n    max_memory_restart: '1G',\n    env: {\n      NODE_ENV: 'production',\n      PORT: 3000\n    }\n  }]\n};\n" > /var/www/bgalin/frontend/ecosystem.config.js
            fi

            # Restart services
            echo "‚ôªÔ∏è Restarting services..."
            sudo systemctl daemon-reload
            sudo systemctl start bgalin-backend.service || sudo systemctl restart bgalin-backend.service

            cd /var/www/bgalin/frontend
            pm2 delete bgalin-frontend 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save

            sudo nginx -t
            sudo systemctl reload nginx

            echo "‚úÖ Checking service status..."
            sudo systemctl is-active bgalin-backend.service
            pm2 list | grep bgalin-frontend

            echo "üéâ Deployment completed successfully!"

            # Send Telegram notification
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.ADMIN_TELEGRAM_ID }}" \
              -d text="‚úÖ Deployment to bgalin.ru completed successfully!%0ACommit: ${{ github.event.head_commit.message }}%0AAuthor: ${{ github.actor }}" \
              > /dev/null || true

      - name: Notify on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.ADMIN_TELEGRAM_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå Deployment to bgalin.ru failed!

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
