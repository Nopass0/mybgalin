name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build Rust backend for ARM64
        working-directory: ./server
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu

      - name: Upload backend binary
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: server/target/aarch64-unknown-linux-gnu/release/server
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download backend binary
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: ./backend-binary

      - name: Copy binary to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "./backend-binary/server"
          target: "/tmp/"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          command_timeout: 60m
          script: |
            set -e

            echo "üöÄ Starting deployment..."

            # Stop services
            sudo systemctl stop bgalin-backend.service || true
            pm2 stop all || true

            # Setup project directory
            echo "üìÅ Setting up project directory..."
            sudo mkdir -p /var/www/bgalin
            sudo chown -R $USER:$USER /var/www/bgalin
            cd /var/www/bgalin

            # Setup SSH key for GitHub
            echo "üîë Setting up SSH authentication..."
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            
            # Clone or update repository using SSH
            echo "üì• Fetching latest code..."
            REPO_URL="git@github.com:Nopass0/mybgalin.git"
            
            if [ -d ".git" ]; then
              git remote set-url origin "$REPO_URL"
              git fetch origin main --depth=1
              git reset --hard origin/main
              git clean -fd
            else
              git clone --depth=1 "$REPO_URL" .
            fi

            # Install system dependencies if needed
            echo "üì¶ Checking system dependencies..."
            
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi

            if ! command -v nginx &> /dev/null; then
              echo "Installing nginx..."
              sudo apt-get install -y nginx
            fi

            # Move pre-built backend binary
            echo "üì¶ Installing backend binary..."
            mkdir -p /var/www/bgalin/server/target/release
            mv /tmp/backend-binary/server /var/www/bgalin/server/target/release/server
            chmod +x /var/www/bgalin/server/target/release/server

            # Create/update .env file
            echo "üîê Updating environment variables..."
            cd server
            cat > .env << 'ENVEOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            ADMIN_TELEGRAM_ID=${{ secrets.ADMIN_TELEGRAM_ID }}
            STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}
            STEAM_ID=${{ secrets.STEAM_ID }}
            FACEIT_API_KEY=${{ secrets.FACEIT_API_KEY }}
            GSI_AUTH_TOKEN=${{ secrets.GSI_AUTH_TOKEN }}
            OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
            AI_MODEL=${{ secrets.AI_MODEL }}
            HH_CLIENT_ID=${{ secrets.HH_CLIENT_ID }}
            HH_CLIENT_SECRET=${{ secrets.HH_CLIENT_SECRET }}
            HH_REDIRECT_URI=https://bgalin.ru/auth/hh/callback
            JOB_SEARCH_INTERVAL_HOURS=${{ secrets.JOB_SEARCH_INTERVAL_HOURS }}
            ROCKET_ADDRESS=0.0.0.0
            ROCKET_PORT=3001
            ROCKET_ENV=production
            ALICE_CLIENT_ID=${{ secrets.ALICE_CLIENT_ID }}
            ALICE_CLIENT_SECRET=${{ secrets.ALICE_CLIENT_SECRET }}
            N8N_API_URL=http://localhost:5678
            N8N_API_KEY=${{ secrets.N8N_API_KEY }}
            ENVEOF

            # Create data directory
            echo "üìÅ Creating data directory..."
            mkdir -p /var/www/bgalin/server/data
            chmod 755 /var/www/bgalin/server/data

            # Build frontend
            echo "üé® Building frontend..."
            cd ../frontend
            rm -rf node_modules package-lock.json
            npm install --build-from-source
            NODE_ENV=production npm run build

            # Setup systemd service
            echo "‚öôÔ∏è Configuring systemd service..."
            sudo bash -c "cat > /etc/systemd/system/bgalin-backend.service << 'EOF'
            [Unit]
            Description=BGalin Backend Service
            After=network.target

            [Service]
            Type=simple
            User=$USER
            WorkingDirectory=/var/www/bgalin/server
            EnvironmentFile=/var/www/bgalin/server/.env
            ExecStart=/var/www/bgalin/server/target/release/server
            Restart=always
            RestartSec=10
            Environment=\"RUST_LOG=info\"

            [Install]
            WantedBy=multi-user.target
            EOF"
            sudo systemctl daemon-reload
            sudo systemctl enable bgalin-backend.service

            # Setup nginx
            echo "üåê Configuring nginx..."
            sudo bash -c "cat > /etc/nginx/sites-available/bgalin << 'EOF'
            server {
                listen 80;
                server_name bgalin.ru www.bgalin.ru;
                return 301 https://\$server_name\$request_uri;
            }

            server {
                listen 443 ssl http2;
                server_name bgalin.ru www.bgalin.ru;

                ssl_certificate /var/www/bgalin/bgalin_ru.crt;
                ssl_certificate_key /var/www/bgalin/private.key;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;

                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                location /api/ {
                    proxy_pass http://localhost:3001/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                location /alice/ {
                    proxy_pass http://localhost:3001/alice/;
                    proxy_http_version 1.1;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
                add_header Referrer-Policy "no-referrer-when-downgrade" always;

                access_log /var/log/nginx/bgalin_access.log;
                error_log /var/log/nginx/bgalin_error.log;
            }
            EOF"
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default

            # Setup PM2 config
            if [ ! -f "/var/www/bgalin/frontend/ecosystem.config.js" ]; then
              echo "üì¶ Creating PM2 config..."
              cat > /var/www/bgalin/frontend/ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'bgalin-frontend',
                script: 'node_modules/next/dist/bin/next',
                args: 'start',
                cwd: '/var/www/bgalin/frontend',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                }
              }]
            };
            EOF
            fi

            # Restart services
            echo "‚ôªÔ∏è Restarting services..."
            sudo systemctl daemon-reload
            sudo systemctl start bgalin-backend.service || sudo systemctl restart bgalin-backend.service

            cd /var/www/bgalin/frontend
            pm2 delete bgalin-frontend 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save

            sudo nginx -t
            sudo systemctl reload nginx

            echo "‚úÖ Checking service status..."
            sudo systemctl is-active bgalin-backend.service
            pm2 list | grep bgalin-frontend

            echo "üéâ Deployment completed successfully!"

            # Send Telegram notification
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.ADMIN_TELEGRAM_ID }}" \
              -d text="‚úÖ Deployment to bgalin.ru completed successfully!%0ACommit: ${{ github.event.head_commit.message }}%0AAuthor: ${{ github.actor }}" \
              > /dev/null || true

      - name: Notify on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.ADMIN_TELEGRAM_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå Deployment to bgalin.ru failed!

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
