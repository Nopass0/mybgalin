name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Clean up before deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # Free up memory before file transfer
            sync && echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null || true
            # Stop services temporarily to free memory
            sudo systemctl stop bgalin-backend.service || true
            pm2 stop bgalin-frontend || true

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "server/,frontend/,.github/"
          target: "/var/www/bgalin"
          rm: false
          strip_components: 0

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          command_timeout: 60m
          script: |
            set -e

            echo "üöÄ Starting deployment..."

            # Check and install system dependencies
            echo "üì¶ Checking system dependencies..."

            # Install git if not present
            if ! command -v git &> /dev/null; then
              echo "Installing git..."
              sudo apt-get update
              sudo apt-get install -y git
            fi

            # Install build essentials if not present
            if ! dpkg -l | grep -q build-essential; then
              echo "Installing build-essential..."
              sudo apt-get update
              sudo apt-get install -y build-essential pkg-config libssl-dev curl clang lld
            fi

            # Install Rust if not present
            if ! command -v cargo &> /dev/null; then
              echo "Installing Rust..."
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source $HOME/.cargo/env
              export PATH="$HOME/.cargo/bin:$PATH"
            fi

            # Install sccache for faster Rust builds
            if ! command -v sccache &> /dev/null; then
              echo "Installing sccache..."
              source $HOME/.cargo/env 2>/dev/null || true
              export PATH="$HOME/.cargo/bin:$PATH"
              cargo install sccache || true
            fi

            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Install Python for native module building
            if ! command -v python3 &> /dev/null; then
              echo "Installing Python..."
              sudo apt-get install -y python3 python3-pip
            fi

            # Install PM2 if not present
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi

            # Install nginx if not present
            if ! command -v nginx &> /dev/null; then
              echo "Installing nginx..."
              sudo apt-get install -y nginx
            fi

            # Ensure project directory ownership
            echo "üìÅ Setting up project directory..."
            sudo chown -R $USER:$USER /var/www/bgalin
            cd /var/www/bgalin

            # Create/update .env file with secrets from GitHub
            echo "üîê Updating environment variables..."
            cd server
            cat > .env << 'ENVEOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            ADMIN_TELEGRAM_ID=${{ secrets.ADMIN_TELEGRAM_ID }}
            STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}
            STEAM_ID=${{ secrets.STEAM_ID }}
            FACEIT_API_KEY=${{ secrets.FACEIT_API_KEY }}
            GSI_AUTH_TOKEN=${{ secrets.GSI_AUTH_TOKEN }}
            OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
            AI_MODEL=${{ secrets.AI_MODEL }}
            HH_CLIENT_ID=${{ secrets.HH_CLIENT_ID }}
            HH_CLIENT_SECRET=${{ secrets.HH_CLIENT_SECRET }}
            HH_REDIRECT_URI=https://bgalin.ru/auth/hh/callback
            JOB_SEARCH_INTERVAL_HOURS=${{ secrets.JOB_SEARCH_INTERVAL_HOURS }}
            ROCKET_ADDRESS=0.0.0.0
            ROCKET_PORT=3001
            ROCKET_ENV=production
            ENVEOF

            # Ensure data directory exists for database
            echo "üìÅ Creating data directory..."
            mkdir -p /var/www/bgalin/server/data
            chmod 755 /var/www/bgalin/server/data

            # Build backend
            echo "üî® Building backend..."
            source $HOME/.cargo/env 2>/dev/null || true
            export PATH="$HOME/.cargo/bin:$PATH"

            # Use sccache if available
            if command -v sccache &> /dev/null; then
              export RUSTC_WRAPPER=sccache
              export SCCACHE_DIR=/var/www/.sccache
              mkdir -p $SCCACHE_DIR
              echo "Using sccache for faster builds..."
            fi

            cargo build --release

            # Show sccache stats
            if command -v sccache &> /dev/null; then
              sccache --show-stats || true
            fi

            # Check if migrations exist and run them
            if [ -d "migrations" ]; then
              echo "üóÑÔ∏è Running database migrations..."
              # Add migration command if you're using sqlx or diesel
              # sqlx migrate run || true
            fi

            # Build frontend
            echo "üé® Building frontend..."
            cd ../frontend

            # Clean install to ensure native modules are built for the correct architecture
            echo "üì¶ Installing frontend dependencies..."
            rm -rf node_modules package-lock.json

            # Install dependencies with proper flags for native modules
            npm install --build-from-source

            NODE_ENV=production npm run build

            # Setup/update systemd service
            echo "‚öôÔ∏è Configuring systemd service..."
            sudo bash -c "cat > /etc/systemd/system/bgalin-backend.service << 'EOF'
            [Unit]
            Description=BGalin Backend Service
            After=network.target

            [Service]
            Type=simple
            User=$USER
            WorkingDirectory=/var/www/bgalin/server
            EnvironmentFile=/var/www/bgalin/server/.env
            ExecStart=/var/www/bgalin/server/target/release/server
            Restart=always
            RestartSec=10
            Environment=\"RUST_LOG=info\"

            [Install]
            WantedBy=multi-user.target
            EOF"
            sudo systemctl daemon-reload
            sudo systemctl enable bgalin-backend.service

            # Setup/update nginx config
            echo "üåê Configuring nginx..."
            sudo bash -c "cat > /etc/nginx/sites-available/bgalin << 'EOF'
            server {
                listen 80;
                server_name bgalin.ru www.bgalin.ru;
                return 301 https://\$server_name\$request_uri;
            }

            server {
                listen 443 ssl http2;
                server_name bgalin.ru www.bgalin.ru;

                ssl_certificate /var/www/bgalin/bgalin_ru.crt;
                ssl_certificate_key /var/www/bgalin/private.key;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;

                # Frontend
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                # Backend API
                location /api/ {
                    proxy_pass http://localhost:3001/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                # Security headers
                add_header X-Frame-Options \"SAMEORIGIN\" always;
                add_header X-Content-Type-Options \"nosniff\" always;
                add_header X-XSS-Protection \"1; mode=block\" always;
                add_header Referrer-Policy \"no-referrer-when-downgrade\" always;

                # Logging
                access_log /var/log/nginx/bgalin_access.log;
                error_log /var/log/nginx/bgalin_error.log;
            }
            EOF"
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default

            # Setup PM2 ecosystem if not exists
            if [ ! -f "/var/www/bgalin/frontend/ecosystem.config.js" ]; then
              echo "üì¶ Creating PM2 config..."
              cat > /var/www/bgalin/frontend/ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'bgalin-frontend',
                script: 'node_modules/next/dist/bin/next',
                args: 'start',
                cwd: '/var/www/bgalin/frontend',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                }
              }]
            };
            EOF
            fi

            # Configure sudo for deployment user
            if [ ! -f "/etc/sudoers.d/bgalin-deploy" ]; then
              echo "üîê Configuring sudo..."
              sudo bash -c "cat > /etc/sudoers.d/bgalin-deploy << 'EOF'
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl restart bgalin-backend.service
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl reload nginx
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl is-active bgalin-backend.service
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl daemon-reload
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl enable bgalin-backend.service
            $USER ALL=(ALL) NOPASSWD: /usr/sbin/nginx
            EOF"
              sudo chmod 0440 /etc/sudoers.d/bgalin-deploy
            fi

            # Restart services
            echo "‚ôªÔ∏è Restarting services..."

            # Start/restart backend
            sudo systemctl daemon-reload
            sudo systemctl start bgalin-backend.service || sudo systemctl restart bgalin-backend.service

            # Start/restart frontend
            cd /var/www/bgalin/frontend
            pm2 delete bgalin-frontend 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save

            # Test and reload nginx
            echo "üîç Testing nginx configuration..."
            sudo nginx -t

            echo "‚ôªÔ∏è Reloading nginx..."
            sudo systemctl reload nginx

            # Check service status
            echo "‚úÖ Checking service status..."
            sudo systemctl is-active bgalin-backend.service
            pm2 list | grep bgalin-frontend

            echo "üìã Nginx configuration for API:"
            sudo grep -A 5 "location /api/" /etc/nginx/sites-available/bgalin

            echo "üéâ Deployment completed successfully!"

            # Send notification to Telegram
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.ADMIN_TELEGRAM_ID }}" \
              -d text="‚úÖ Deployment to bgalin.ru completed successfully!%0ACommit: ${{ github.event.head_commit.message }}%0AAuthor: ${{ github.actor }}" \
              > /dev/null || true

      - name: Notify on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.ADMIN_TELEGRAM_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå Deployment to bgalin.ru failed!

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
