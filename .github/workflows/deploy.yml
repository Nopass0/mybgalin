name: Deploy

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  # Build and push Docker images to GitHub Container Registry
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ env.BACKEND_IMAGE }}:latest,${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.FRONTEND_IMAGE }}:latest,${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Run Prisma migrations
  migrate:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        working-directory: ./server
        run: bun install
      
      - name: Generate Prisma Client
        working-directory: ./server
        run: bunx prisma generate
      
      - name: Push schema to database
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: bunx prisma db push --accept-data-loss

  # Deploy to server
  deploy:
    runs-on: ubuntu-latest
    needs: [build, migrate]
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_TELEGRAM_ID: ${{ secrets.ADMIN_TELEGRAM_ID }}
          BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend:latest
          FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend:latest
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 300s
          command_timeout: 300s
          envs: DATABASE_URL,TELEGRAM_BOT_TOKEN,ADMIN_TELEGRAM_ID,BACKEND_IMAGE,FRONTEND_IMAGE
          script: |
            set -e
            
            echo "============================================"
            echo "    BGalin Deployment Started"
            echo "============================================"
            
            DEPLOY_DIR="/var/www/bgalin"
            
            # Ensure directory exists
            if [ ! -d "$DEPLOY_DIR" ]; then
              sudo mkdir -p "$DEPLOY_DIR"
              sudo chown -R $(whoami):$(whoami) "$DEPLOY_DIR"
            fi
            
            cd "$DEPLOY_DIR"
            
            # Update repository (for nginx config and docker-compose)
            if [ ! -d .git ]; then
              git clone https://github.com/Nopass0/mybgalin.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi
            echo "[OK] Repository updated"
            
            # Create .env file
            cat > .env << EOF
            DATABASE_URL=${DATABASE_URL}
            TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
            ADMIN_TELEGRAM_ID=${ADMIN_TELEGRAM_ID}
            NODE_ENV=production
            BACKEND_IMAGE=${BACKEND_IMAGE}
            FRONTEND_IMAGE=${FRONTEND_IMAGE}
            EOF
            echo "[OK] Environment configured"
            
            # Note: Images are public, no login needed
            
            # Pull new images
            echo "Pulling images..."
            sudo docker pull ${BACKEND_IMAGE} || true
            sudo docker pull ${FRONTEND_IMAGE} || true
            sudo docker pull n8nio/n8n:1.70.1 || true
            echo "[OK] Images pulled"
            
            # Restart services
            echo "Restarting services..."
            sudo docker compose down --remove-orphans 2>/dev/null || true
            sudo docker compose up -d
            
            # Wait for services
            echo "Waiting for services to start..."
            sleep 15
            
            # Show status
            echo ""
            echo "Service status:"
            sudo docker compose ps
            
            # Show backend logs
            echo ""
            echo "Backend logs:"
            sudo docker compose logs backend --tail 20 2>/dev/null || true
            
            # Configure Nginx
            sudo cp nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            sudo nginx -t && sudo systemctl reload nginx
            echo "[OK] Nginx configured"
            
            # Verify
            echo ""
            echo "Testing services..."
            curl -s http://localhost:8000/api/health || echo "[WARN] Backend not responding"
            curl -s -o /dev/null -w "Frontend: %{http_code}\n" http://localhost:3000 || true
            
            echo ""
            echo "============================================"
            echo "    Deployment Complete!"
            echo "============================================"
            sudo docker compose ps
