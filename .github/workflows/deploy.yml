name: Deploy

on:
  push:
    branches: [main]

jobs:
  # Run Prisma migrations
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        working-directory: ./server
        run: bun install
      
      - name: Generate Prisma Client
        working-directory: ./server
        run: bunx prisma generate
      
      - name: Push schema to database
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: bunx prisma db push --accept-data-loss

  # Deploy to server - build directly on ARM64 server
  deploy:
    runs-on: ubuntu-latest
    needs: migrate
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_TELEGRAM_ID: ${{ secrets.ADMIN_TELEGRAM_ID }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 1800s
          command_timeout: 1800s
          envs: DATABASE_URL,TELEGRAM_BOT_TOKEN,ADMIN_TELEGRAM_ID
          script: |
            set -e
            
            echo "============================================"
            echo "    BGalin Deployment Started"
            echo "============================================"
            
            DEPLOY_DIR="/var/www/bgalin"
            
            # Ensure directory exists
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown -R $(whoami):$(whoami) "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Update repository
            if [ ! -d .git ]; then
              git clone https://github.com/Nopass0/mybgalin.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi
            echo "[OK] Repository updated"
            
            # Create .env file
            cat > .env << EOF
            DATABASE_URL=${DATABASE_URL}
            TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
            ADMIN_TELEGRAM_ID=${ADMIN_TELEGRAM_ID}
            NODE_ENV=production
            EOF
            echo "[OK] Environment configured"
            
            # Start Docker
            sudo systemctl start docker 2>/dev/null || true
            
            # Check if images exist, only rebuild if needed
            BACKEND_EXISTS=$(sudo docker images -q bgalin-backend 2>/dev/null)
            FRONTEND_EXISTS=$(sudo docker images -q bgalin-frontend 2>/dev/null)
            
            # Get latest commit hash
            CURRENT_COMMIT=$(git rev-parse --short HEAD)
            BUILT_COMMIT=$(cat .built_commit 2>/dev/null || echo "none")
            
            echo "Current commit: $CURRENT_COMMIT"
            echo "Built commit: $BUILT_COMMIT"
            
            # Rebuild only if commit changed or images don't exist
            if [ "$CURRENT_COMMIT" != "$BUILT_COMMIT" ] || [ -z "$BACKEND_EXISTS" ] || [ -z "$FRONTEND_EXISTS" ]; then
              echo "Building Docker images..."
              
              export DOCKER_BUILDKIT=1
              export COMPOSE_DOCKER_CLI_BUILD=1
              
              # Pull n8n
              sudo docker pull n8nio/n8n:1.70.1 || true
              
              # Build with cache
              sudo -E docker compose build --parallel 2>&1 || {
                echo "Parallel build failed, trying sequential..."
                sudo -E docker compose build 2>&1
              }
              
              # Save commit hash
              echo "$CURRENT_COMMIT" > .built_commit
              echo "[OK] Images built"
            else
              echo "[OK] Images already up to date, skipping build"
            fi
            
            # Restart services
            echo "Restarting services..."
            sudo docker compose down --remove-orphans 2>/dev/null || true
            sudo docker compose up -d
            
            # Wait for services
            echo "Waiting for services to start..."
            sleep 20
            
            # Show status
            echo ""
            echo "Service status:"
            sudo docker compose ps
            
            # Show logs
            echo ""
            echo "Backend logs:"
            sudo docker compose logs backend --tail 30 2>/dev/null || true
            
            # Configure Nginx
            sudo cp nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            sudo nginx -t && sudo systemctl reload nginx
            echo "[OK] Nginx configured"
            
            # Verify
            echo ""
            echo "Testing services..."
            sleep 5
            curl -s http://localhost:8000/api/health || echo "[WARN] Backend not responding"
            curl -s -o /dev/null -w "Frontend: %{http_code}\n" http://localhost:3000 || true
            
            echo ""
            echo "============================================"
            echo "    Deployment Complete!"
            echo "============================================"
            sudo docker compose ps
