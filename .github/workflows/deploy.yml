name: Deploy

on:
  push:
    branches: [main]

jobs:
  # Run Prisma migrations to Neon database
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        working-directory: ./server
        run: bun install
      
      - name: Generate Prisma Client
        working-directory: ./server
        run: bunx prisma generate
      
      - name: Push schema to Neon database
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: bunx prisma db push --accept-data-loss

  deploy:
    runs-on: ubuntu-latest
    needs: migrate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 900s
          command_timeout: 900s
          envs: DATABASE_URL
          script: |
            set -e
            
            echo "============================================"
            echo "    BGalin Deployment Started"
            echo "============================================"
            
            # ============================================
            # 1. SETUP PREREQUISITES
            # ============================================
            echo ""
            echo "=== 1. Setup Prerequisites ==="
            
            # Install Bun
            if ! [ -f "$HOME/.bun/bin/bun" ]; then
              curl -fsSL https://bun.sh/install | bash
              sleep 2
            fi
            export PATH="$HOME/.bun/bin:$PATH"
            echo "[OK] Bun ready"
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker $USER
            fi
            
            # Start Docker daemon
            sudo systemctl start docker 2>/dev/null || sudo service docker start || true
            sudo systemctl enable docker 2>/dev/null || true
            
            # Wait for Docker daemon
            echo "Waiting for Docker daemon..."
            for i in {1..30}; do
              if sudo docker ps &>/dev/null; then
                echo "[OK] Docker ready"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "[WARN] Docker may not be ready"
              fi
              sleep 1
            done
            
            # Install Nginx
            if ! command -v nginx &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            sudo systemctl enable nginx 2>/dev/null || true
            echo "[OK] Nginx ready"
            
            # ============================================
            # 2. UPDATE REPOSITORY
            # ============================================
            echo ""
            echo "=== 2. Update Repository ==="
            
            DEPLOY_DIR="/var/www/bgalin"
            
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Creating deployment directory: $DEPLOY_DIR"
              sudo mkdir -p "$DEPLOY_DIR"
              sudo chown -R $(whoami):$(whoami) "$DEPLOY_DIR"
            fi
            
            cd "$DEPLOY_DIR"
            
            if [ ! -d .git ]; then
              git clone https://github.com/Nopass0/mybgalin.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi
            echo "[OK] Repository updated"
            
            # ============================================
            # 3. CREATE ENVIRONMENT FILE
            # ============================================
            echo ""
            echo "=== 3. Configure Environment ==="
            
            cat > /var/www/bgalin/.env << ENVEOF
            DATABASE_URL=${DATABASE_URL}
            NODE_ENV=production
            ENVEOF
            
            echo "[OK] Environment configured"
            
            # ============================================
            # 4. STOP EXISTING SERVICES
            # ============================================
            echo ""
            echo "=== 4. Stop Existing Services ==="
            
            cd /var/www/bgalin
            
            # Stop existing containers gracefully
            sudo docker compose down --remove-orphans 2>/dev/null || true
            
            # Clean up old/dangling images only (keep cache)
            sudo docker image prune -f 2>/dev/null || true
            
            echo "[OK] Old services stopped"
            
            # ============================================
            # 5. BUILD AND START SERVICES
            # ============================================
            echo ""
            echo "=== 5. Build and Start Services ==="
            
            cd /var/www/bgalin
            
            # Enable BuildKit for better builds with cache
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            
            # Build images (use cache for faster builds)
            echo "Building Docker images..."
            sudo -E docker compose build 2>&1 | tail -50
            
            # Start services
            echo "Starting services..."
            sudo docker compose up -d
            
            # Wait for services to start
            echo "Waiting for services to start..."
            sleep 15
            
            # Verify services
            echo "Service status:"
            sudo docker compose ps
            
            # Check if containers are running
            RUNNING=$(sudo docker compose ps --format json 2>/dev/null | grep -c '"running"' || echo "0")
            if [ "$RUNNING" -lt 2 ]; then
              echo "[WARN] Some services may not be running properly"
              echo "Logs from backend:"
              sudo docker compose logs backend --tail 20 2>/dev/null || true
              echo "Logs from frontend:"
              sudo docker compose logs frontend --tail 20 2>/dev/null || true
              echo "Logs from n8n:"
              sudo docker compose logs n8n --tail 20 2>/dev/null || true
            fi
            
            echo "[OK] Services started"
            
            # ============================================
            # 6. CONFIGURE NGINX
            # ============================================
            echo ""
            echo "=== 6. Configure Nginx ==="
            
            sudo cp /var/www/bgalin/nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            # Test nginx config
            if sudo nginx -t 2>&1 | grep -q "successful"; then
              sudo systemctl reload nginx || sudo systemctl restart nginx
              echo "[OK] Nginx configured and reloaded"
            else
              echo "[ERROR] Nginx config test failed:"
              sudo nginx -t
              sudo systemctl restart nginx || true
            fi
            
            # ============================================
            # 7. VERIFY DEPLOYMENT
            # ============================================
            echo ""
            echo "=== 7. Verify Deployment ==="
            
            # Check each service
            echo "Checking services..."
            
            # Frontend check
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200\|301\|302"; then
              echo "[OK] Frontend is responding"
            else
              echo "[WARN] Frontend may not be responding"
            fi
            
            # Backend check  
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health 2>/dev/null | grep -qE "200|404"; then
              echo "[OK] Backend is responding"
            else
              echo "[WARN] Backend may not be responding"
            fi
            
            # N8N check
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:5678/n8n/ 2>/dev/null | grep -qE "200|301|302"; then
              echo "[OK] N8N is responding"
            else
              echo "[WARN] N8N may not be responding"
            fi
            
            # ============================================
            # DEPLOYMENT COMPLETE
            # ============================================
            echo ""
            echo "============================================"
            echo "    Deployment Complete!"
            echo "============================================"
            echo ""
            echo "Services:"
            sudo docker compose ps
            echo ""
            echo "Access URLs:"
            echo "  Frontend:  https://bgalin.ru"
            echo "  Backend:   https://bgalin.ru/api/health"
            echo "  N8N:       https://bgalin.ru/n8n/"
            echo ""
            echo "Commands:"
            echo "  cd /var/www/bgalin"
            echo "  docker compose logs -f        # View all logs"
            echo "  docker compose logs backend   # Backend logs"
            echo "  docker compose logs frontend  # Frontend logs"
            echo "  docker compose logs n8n       # N8N logs"
            echo "  docker compose restart        # Restart all"
