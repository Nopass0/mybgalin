name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 300s
          script: |
            set -e
            
            echo "╔════════════════════════════════════════╗"
            echo "║    BGalin Deployment Started           ║"
            echo "╚════════════════════════════════════════╝"
            
            # ============================================
            # 1. SETUP PREREQUISITES
            # ============================================
            echo ""
            echo "=== 1. Setup Prerequisites ==="
            
            # Install Bun if needed
            if ! [ -f "$HOME/.bun/bin/bun" ]; then
              echo "Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              sleep 2
            fi
            export PATH="$HOME/.bun/bin:$PATH"
            echo "✓ Bun ready"
            
            # Install Node.js
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "✓ Node.js ready"
            
            # Install PM2
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
              pm2 startup 2>/dev/null || true
              pm2 save 2>/dev/null || true
            fi
            echo "✓ PM2 ready"
            
            # ============================================
            # 2. UPDATE REPOSITORY
            # ============================================
            echo ""
            echo "=== 2. Update Repository ==="
            cd /var/www/bgalin
            git fetch origin main
            git reset --hard origin/main
            echo "✓ Repository updated"
            
            # ============================================
            # 3. BUILD FRONTEND
            # ============================================
            echo ""
            echo "=== 3. Build Frontend ==="
            cd /var/www/bgalin/frontend
            export NODE_OPTIONS="--max-old-space-size=256"
            npm install --prefer-offline 2>&1 | tail -3
            npm run build 2>&1 | tail -5 || echo "⚠ Build issues, using dev mode"
            echo "✓ Frontend ready"
            
            # ============================================
            # 4. BUILD BACKEND
            # ============================================
            echo ""
            echo "=== 4. Build Backend ==="
            cd /var/www/bgalin/server
            bun install --prefer-offline 2>&1 | tail -3
            echo "✓ Backend ready"
            
            # ============================================
            # 5. STOP OLD SERVICES
            # ============================================
            echo ""
            echo "=== 5. Stop Old Services ==="
            pm2 kill 2>/dev/null || true
            sleep 2
            echo "✓ Old services stopped"
            
            # ============================================
            # 6. START BACKEND
            # ============================================
            echo ""
            echo "=== 6. Start Backend ==="
            cd /var/www/bgalin/server
            pm2 start "bun" --name backend -- run src/index.ts \
              --max-memory-restart 300M 2>&1 | tail -3
            sleep 3
            echo "Backend status:"
            pm2 status backend || echo "Backend status check"
            
            # ============================================
            # 7. START FRONTEND
            # ============================================
            echo ""
            echo "=== 7. Start Frontend ==="
            cd /var/www/bgalin/frontend
            pm2 start "npm" --name frontend -- start \
              --max-memory-restart 500M 2>&1 | tail -3
            sleep 3
            echo "Frontend status:"
            pm2 status frontend || echo "Frontend status check"
            
            # ============================================
            # 8. SETUP NGINX
            # ============================================
            echo ""
            echo "=== 8. Setup Nginx ==="
            if ! command -v nginx &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            sudo cp /var/www/bgalin/nginx-bgalin.conf /etc/nginx/sites-available/bgalin 2>/dev/null || true
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            if sudo nginx -t 2>&1 | grep -q "successful"; then
              sudo systemctl restart nginx
              echo "✓ Nginx configured"
            else
              echo "⚠ Nginx config issue"
              sudo systemctl restart nginx || true
            fi
            
            # ============================================
            # 9. SAVE PM2
            # ============================================
            echo ""
            echo "=== 9. Save PM2 State ==="
            pm2 save 2>/dev/null || true
            echo "✓ PM2 state saved"
            
            # ============================================
            # 10. SUMMARY
            # ============================================
            echo ""
            echo "╔════════════════════════════════════════╗"
            echo "║  ✅ Deployment Complete               ║"
            echo "╚════════════════════════════════════════╝"
            echo ""
            echo "PM2 Services:"
            pm2 status
            echo ""
            echo "Access:"
            echo "  Frontend:  http://localhost:3000"
            echo "  Backend:   http://localhost:8000"
            echo "  Nginx:     http://bgalin.ru"
