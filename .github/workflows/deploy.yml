name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH (git pull)
        uses: appleboy/ssh-action@master
        env:
          GH_TOKEN: ${{ secrets.GTHUB_TOKEN }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          command_timeout: 60m
          envs: GH_TOKEN,GITHUB_REPOSITORY
          script: |
            set -e

            echo "üöÄ Starting deployment..."

            # Free up memory
            sync && echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null || true

            # Stop services to free memory
            sudo systemctl stop bgalin-backend.service || true
            pm2 stop all || true

            # Setup project directory
            echo "üìÅ Setting up project directory..."
            sudo mkdir -p /var/www/bgalin
            sudo chown -R $USER:$USER /var/www/bgalin
            cd /var/www/bgalin

            # Clone or update repository using git with token authentication
            echo "üì• Fetching latest code..."
            REPO_URL="https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            
            if [ -d ".git" ]; then
              # Repository exists, update remote URL and fetch
              git remote set-url origin "$REPO_URL"
              git fetch origin main --depth=1
              git reset --hard origin/main
              git clean -fd
            else
              # Clone repository with token
              git clone --depth=1 "$REPO_URL" .
            fi

            # Check and install system dependencies
            echo "üì¶ Checking system dependencies..."

            # Install git if not present
            if ! command -v git &> /dev/null; then
              echo "Installing git..."
              sudo apt-get update
              sudo apt-get install -y git
            fi

            # Install build essentials if not present
            if ! dpkg -l | grep -q build-essential; then
              echo "Installing build-essential..."
              sudo apt-get update
              sudo apt-get install -y build-essential pkg-config libssl-dev curl clang lld
            fi

            # Install Rust if not present
            if ! command -v cargo &> /dev/null; then
              echo "Installing Rust..."
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source $HOME/.cargo/env
              export PATH="$HOME/.cargo/bin:$PATH"
            fi

            # Install sccache for faster Rust builds
            if ! command -v sccache &> /dev/null; then
              echo "Installing sccache..."
              source $HOME/.cargo/env 2>/dev/null || true
              export PATH="$HOME/.cargo/bin:$PATH"
              cargo install sccache || true
            fi

            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Install Python for native module building
            if ! command -v python3 &> /dev/null; then
              echo "Installing Python..."
              sudo apt-get install -y python3 python3-pip
            fi

            # Install PM2 if not present
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi

            # Install nginx if not present
            if ! command -v nginx &> /dev/null; then
              echo "Installing nginx..."
              sudo apt-get install -y nginx
            fi

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              rm get-docker.sh
              sudo usermod -aG docker $USER
            fi

            # Start Docker services (n8n)
            echo "üê≥ Starting Docker services (n8n)..."
            cd /var/www/bgalin
            
            # Create n8n docker-compose for production (using Neon DB, not local postgres)
            cat > docker-compose.prod.yml << 'DOCKEREOF'
            version: '3.8'
            services:
              n8n:
                image: n8nio/n8n:latest
                restart: always
                ports:
                  - "5678:5678"
                environment:
                  - N8N_HOST=bgalin.ru
                  - N8N_PORT=5678
                  - N8N_PROTOCOL=https
                  - N8N_PATH_PREFIX=/n8n
                  - NODE_ENV=production
                  - WEBHOOK_URL=https://bgalin.ru/webhook/
                  - GENERIC_TIMEZONE=Europe/Moscow
                  - NODE_FUNCTION_ALLOW_EXTERNAL=axios,zustand,zod,dayjs,lodash
                  - DB_TYPE=postgresdb
                  - DB_POSTGRESDB_HOST=${{ secrets.NEON_DB_HOST }}
                  - DB_POSTGRESDB_PORT=5432
                  - DB_POSTGRESDB_DATABASE=${{ secrets.NEON_DB_NAME }}
                  - DB_POSTGRESDB_USER=${{ secrets.NEON_DB_USER }}
                  - DB_POSTGRESDB_PASSWORD=${{ secrets.NEON_DB_PASSWORD }}
                  - DB_POSTGRESDB_SSL_ENABLED=true
                volumes:
                  - n8n_data:/home/node/.n8n
            volumes:
              n8n_data:
            DOCKEREOF

            docker compose -f docker-compose.prod.yml up -d

            # Create/update .env file with secrets from GitHub
            echo "üîê Updating environment variables..."
            cd server
            cat > .env << 'ENVEOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            ADMIN_TELEGRAM_ID=${{ secrets.ADMIN_TELEGRAM_ID }}
            STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}
            STEAM_ID=${{ secrets.STEAM_ID }}
            FACEIT_API_KEY=${{ secrets.FACEIT_API_KEY }}
            GSI_AUTH_TOKEN=${{ secrets.GSI_AUTH_TOKEN }}
            OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
            AI_MODEL=${{ secrets.AI_MODEL }}
            HH_CLIENT_ID=${{ secrets.HH_CLIENT_ID }}
            HH_CLIENT_SECRET=${{ secrets.HH_CLIENT_SECRET }}
            HH_REDIRECT_URI=https://bgalin.ru/auth/hh/callback
            JOB_SEARCH_INTERVAL_HOURS=${{ secrets.JOB_SEARCH_INTERVAL_HOURS }}
            ROCKET_ADDRESS=0.0.0.0
            ROCKET_PORT=3001
            ROCKET_ENV=production
            ALICE_CLIENT_ID=${{ secrets.ALICE_CLIENT_ID }}
            ALICE_CLIENT_SECRET=${{ secrets.ALICE_CLIENT_SECRET }}
            N8N_API_URL=http://localhost:5678
            N8N_API_KEY=${{ secrets.N8N_API_KEY }}
            ENVEOF

            # Ensure data directory exists for database
            echo "üìÅ Creating data directory..."
            mkdir -p /var/www/bgalin/server/data
            chmod 755 /var/www/bgalin/server/data

            # Build backend
            echo "üî® Building backend..."
            source $HOME/.cargo/env 2>/dev/null || true
            export PATH="$HOME/.cargo/bin:$PATH"

            # Use sccache if available
            if command -v sccache &> /dev/null; then
              export RUSTC_WRAPPER=sccache
              export SCCACHE_DIR=/var/www/.sccache
              mkdir -p $SCCACHE_DIR
              echo "Using sccache for faster builds..."
            fi

            cargo build --release

            # Show sccache stats
            if command -v sccache &> /dev/null; then
              sccache --show-stats || true
            fi

            # Build frontend
            echo "üé® Building frontend..."
            cd ../frontend

            # Clean install to ensure native modules are built for the correct architecture
            echo "üì¶ Installing frontend dependencies..."
            rm -rf node_modules package-lock.json

            # Install dependencies with proper flags for native modules
            npm install --build-from-source

            NODE_ENV=production npm run build

            # Setup/update systemd service
            echo "‚öôÔ∏è Configuring systemd service..."
            sudo bash -c "cat > /etc/systemd/system/bgalin-backend.service << 'EOF'
            [Unit]
            Description=BGalin Backend Service
            After=network.target

            [Service]
            Type=simple
            User=$USER
            WorkingDirectory=/var/www/bgalin/server
            EnvironmentFile=/var/www/bgalin/server/.env
            ExecStart=/var/www/bgalin/server/target/release/server
            Restart=always
            RestartSec=10
            Environment=\"RUST_LOG=info\"

            [Install]
            WantedBy=multi-user.target
            EOF"
            sudo systemctl daemon-reload
            sudo systemctl enable bgalin-backend.service

            # Setup/update nginx config
            echo "üåê Configuring nginx..."
            sudo bash -c "cat > /etc/nginx/sites-available/bgalin << 'EOF'
            server {
                listen 80;
                server_name bgalin.ru www.bgalin.ru;
                return 301 https://\$server_name\$request_uri;
            }

            server {
                listen 443 ssl http2;
                server_name bgalin.ru www.bgalin.ru;

                ssl_certificate /var/www/bgalin/bgalin_ru.crt;
                ssl_certificate_key /var/www/bgalin/private.key;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;

                # Frontend
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                # Backend API
                location /api/ {
                    proxy_pass http://localhost:3001/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                # Alice Smart Home API (at root path)
                location /alice/ {
                    proxy_pass http://localhost:3001/alice/;
                    proxy_http_version 1.1;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                # n8n Workflow Automation
                location /n8n/ {
                    proxy_pass http://localhost:5678/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_buffering off;
                    client_max_body_size 100M;
                }

                # n8n Webhooks
                location /webhook/ {
                    proxy_pass http://localhost:5678/webhook/;
                    proxy_http_version 1.1;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                # Security headers
                add_header X-Frame-Options \"SAMEORIGIN\" always;
                add_header X-Content-Type-Options \"nosniff\" always;
                add_header X-XSS-Protection \"1; mode=block\" always;
                add_header Referrer-Policy \"no-referrer-when-downgrade\" always;

                # Logging
                access_log /var/log/nginx/bgalin_access.log;
                error_log /var/log/nginx/bgalin_error.log;
            }
            EOF"
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default

            # Setup PM2 ecosystem if not exists
            if [ ! -f "/var/www/bgalin/frontend/ecosystem.config.js" ]; then
              echo "üì¶ Creating PM2 config..."
              cat > /var/www/bgalin/frontend/ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'bgalin-frontend',
                script: 'node_modules/next/dist/bin/next',
                args: 'start',
                cwd: '/var/www/bgalin/frontend',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                }
              }]
            };
            EOF
            fi

            # Configure sudo for deployment user
            if [ ! -f "/etc/sudoers.d/bgalin-deploy" ]; then
              echo "üîê Configuring sudo..."
              sudo bash -c "cat > /etc/sudoers.d/bgalin-deploy << 'EOF'
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl restart bgalin-backend.service
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl reload nginx
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl is-active bgalin-backend.service
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl daemon-reload
            $USER ALL=(ALL) NOPASSWD: /bin/systemctl enable bgalin-backend.service
            $USER ALL=(ALL) NOPASSWD: /usr/sbin/nginx
            EOF"
              sudo chmod 0440 /etc/sudoers.d/bgalin-deploy
            fi

            # Restart services
            echo "‚ôªÔ∏è Restarting services..."

            # Start/restart backend
            sudo systemctl daemon-reload
            sudo systemctl start bgalin-backend.service || sudo systemctl restart bgalin-backend.service

            # Start/restart frontend
            cd /var/www/bgalin/frontend
            pm2 delete bgalin-frontend 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save

            # Test and reload nginx
            echo "üîç Testing nginx configuration..."
            sudo nginx -t

            echo "‚ôªÔ∏è Reloading nginx..."
            sudo systemctl reload nginx

            # Check service status
            echo "‚úÖ Checking service status..."
            sudo systemctl is-active bgalin-backend.service
            pm2 list | grep bgalin-frontend

            echo "üìã Nginx configuration for API:"
            sudo grep -A 5 "location /api/" /etc/nginx/sites-available/bgalin

            echo "üéâ Deployment completed successfully!"

            # Send notification to Telegram
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.ADMIN_TELEGRAM_ID }}" \
              -d text="‚úÖ Deployment to bgalin.ru completed successfully!%0ACommit: ${{ github.event.head_commit.message }}%0AAuthor: ${{ github.actor }}" \
              > /dev/null || true

      - name: Notify on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.ADMIN_TELEGRAM_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå Deployment to bgalin.ru failed!

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
