name: Deploy

on:
  push:
    branches: [main]

jobs:
  # Run Prisma migrations
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        working-directory: ./server
        run: bun install
      
      - name: Generate Prisma Client
        working-directory: ./server
        run: bunx prisma generate
      
      - name: Push schema to database
        working-directory: ./server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: bunx prisma db push --accept-data-loss

  # Deploy to server without Docker - direct PM2
  deploy:
    runs-on: ubuntu-latest
    needs: migrate
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ADMIN_TELEGRAM_ID: ${{ secrets.ADMIN_TELEGRAM_ID }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 600s
          command_timeout: 600s
          envs: DATABASE_URL,TELEGRAM_BOT_TOKEN,ADMIN_TELEGRAM_ID
          script: |
            set -e
            
            echo "============================================"
            echo "    BGalin Deployment (No Docker)"
            echo "============================================"
            
            DEPLOY_DIR="/var/www/bgalin"
            
            # Ensure directory exists
            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown -R $(whoami):$(whoami) "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Update repository
            if [ ! -d .git ]; then
              git clone https://github.com/Nopass0/mybgalin.git .
            else
              git fetch origin main
              git reset --hard origin/main
            fi
            echo "[OK] Repository updated"
            
            # Install Node.js and Bun if not present
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            if ! command -v bun &> /dev/null; then
              echo "Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              export PATH="$HOME/.bun/bin:$PATH"
            fi
            export PATH="$HOME/.bun/bin:$PATH"
            
            # Install PM2 globally if not present
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi
            
            echo "[OK] Runtime installed"
            
            # Create .env for backend
            cat > server/.env << EOF
            DATABASE_URL=${DATABASE_URL}
            TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
            ADMIN_TELEGRAM_ID=${ADMIN_TELEGRAM_ID}
            NODE_ENV=production
            PORT=8000
            EOF
            echo "[OK] Backend env configured"
            
            # Build Backend
            echo "Building backend..."
            cd "$DEPLOY_DIR/server"
            bun install
            bunx prisma generate
            echo "[OK] Backend ready"
            
            # Build Frontend
            echo "Building frontend..."
            cd "$DEPLOY_DIR/frontend"
            npm ci
            npm run build
            
            # Copy static files to standalone
            cp -r public "$DEPLOY_DIR/frontend/.next/standalone/" 2>/dev/null || true
            cp -r .next/static "$DEPLOY_DIR/frontend/.next/standalone/.next/" 2>/dev/null || true
            echo "[OK] Frontend built"
            
            # Create PM2 log directory
            sudo mkdir -p /var/log/pm2
            sudo chown -R $(whoami):$(whoami) /var/log/pm2
            
            # Stop existing services
            cd "$DEPLOY_DIR"
            pm2 delete all 2>/dev/null || true
            
            # Start services with PM2
            echo "Starting services..."
            pm2 start ecosystem.config.js
            pm2 save
            
            # Start n8n via Docker (it's the easiest way)
            echo "Starting n8n..."
            sudo docker stop n8n 2>/dev/null || true
            sudo docker rm n8n 2>/dev/null || true
            sudo docker run -d \
              --name n8n \
              --restart always \
              -p 5678:5678 \
              -e N8N_HOST=bgalin.ru \
              -e N8N_PORT=5678 \
              -e N8N_PROTOCOL=https \
              -e N8N_PATH=/n8n/ \
              -e N8N_EDITOR_BASE_URL=https://bgalin.ru/n8n/ \
              -e WEBHOOK_URL=https://bgalin.ru/n8n/ \
              -e NODE_ENV=production \
              -e GENERIC_TIMEZONE=Europe/Moscow \
              -e N8N_SECURE_COOKIE=true \
              -v n8n_data:/home/node/.n8n \
              n8nio/n8n:1.70.1
            echo "[OK] n8n started"
            
            # Setup PM2 startup
            sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u $(whoami) --hp $HOME 2>/dev/null || true
            
            # Wait for services
            echo "Waiting for services to start..."
            sleep 10
            
            # Configure Nginx
            sudo cp nginx-bgalin.conf /etc/nginx/sites-available/bgalin
            sudo ln -sf /etc/nginx/sites-available/bgalin /etc/nginx/sites-enabled/bgalin
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            sudo nginx -t && sudo systemctl reload nginx
            echo "[OK] Nginx configured"
            
            # Verify
            echo ""
            echo "Testing services..."
            sleep 5
            curl -s http://localhost:8000/api/health || echo "[WARN] Backend not responding yet"
            curl -s -o /dev/null -w "Frontend: %{http_code}\n" http://localhost:3000 || echo "[WARN] Frontend not responding yet"
            curl -s -o /dev/null -w "n8n: %{http_code}\n" http://localhost:5678/n8n/ || echo "[WARN] n8n not responding yet"
            
            echo ""
            echo "============================================"
            echo "    Deployment Complete!"
            echo "============================================"
            pm2 status
